#!/bin/bash

# å½“ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡ºè„šæœ¬
set -e

echo " Giteeä¸Šä¼ ä»£ç ç‰ˆæœ¬è‡ªåŠ¨éƒ¨ç½²è„šæœ¬..."
echo "------------------------------------"

# æ£€æŸ¥ Docker æ˜¯å¦æ­£åœ¨è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Docker å®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Dockerï¼"
  exit 1
fi

# --- éƒ¨ç½² Traefik ---
echo "ğŸš€ æ­£åœ¨å¯åŠ¨/æ›´æ–° Traefik..."
# è¿›å…¥ traefik ç›®å½•
cd traefik || exit
# å¯åŠ¨ Traefik æœåŠ¡ã€‚å¦‚æœæœåŠ¡å·²åœ¨è¿è¡Œï¼Œæ­¤å‘½ä»¤ä¼šå¹³æ»‘æ›´æ–°å®ƒã€‚
docker-compose up -d
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..
echo "âœ… Traefik å·²æˆåŠŸå¯åŠ¨ã€‚"
echo "------------------------------------"


# --- éƒ¨ç½²ä¸»åº”ç”¨ ---
echo "ğŸš€ æ­£åœ¨æ„å»ºå¹¶éƒ¨ç½²æ‚¨çš„åº”ç”¨ (ketuai-backend & ketuai-frontend)..."
# ä½¿ç”¨ --build æ ‡å¿—å¼ºåˆ¶é‡æ–°æ„å»ºé•œåƒï¼Œä»¥åº”ç”¨ä»£ç æ›´æ”¹
# ä½¿ç”¨ --remove-orphans æ¸…ç†æ‰æ—§ç‰ˆæœ¬å¯èƒ½é—ç•™çš„å®¹å™¨
docker-compose up -d --build --remove-orphans
echo "âœ… åº”ç”¨éƒ¨ç½²æˆåŠŸï¼"
echo "------------------------------------"

echo "ğŸ‰ å…¨éƒ¨å®Œæˆï¼"
echo "ğŸŒ æ‚¨çš„ç½‘ç«™åº”è¯¥å·²ç»å¯ä»¥é€šè¿‡ https://www.ketuzx.com è®¿é—®"
echo "ğŸ“ˆ Traefik ç®¡ç†é¢æ¿ (ç”¨äºè°ƒè¯•): http://<æ‚¨æœåŠ¡å™¨çš„å…¬ç½‘IP>:8080" 